services:
  # Go application with hot reload
  app:
    build:
      context: .
      target: development
      dockerfile: Dockerfile
    container_name: linkgenai-app-dev
    ports:
      - "${APP_PORT:-8080}:8000"
    develop:
      watch:
        - action: sync
          path: ./src
          target: /app
          ignore:
            - tmp/
        - action: rebuild
          path: go.mod
        - action: rebuild
          path: go.sum
    volumes:
      # Cache go modules
      - go-modules:/go/pkg/mod
      # Mount seed directory
      - ./seed:/app/seed:ro
    env_file:
      - .env
    environment:
      # Override with Docker service names
      - LINKGEN_MONGODB_URI=mongodb://mongodb:27017/linkgenai
      - LINKGEN_NATS_URL=nats://nats:4222
      - LINKGEN_LLM_ENDPOINT=http://100.105.212.98:8317/
      - LINKGEN_LLM_MODEL=claude-3-7-sonnet-20250219
      - LINKGEN_LLM_API_KEY=proxy-key-not-needed
    depends_on:
      mongodb:
        condition: service_healthy
      nats:
        condition: service_started
    networks:
      - linkgenai-network
    restart: unless-stopped

  # MongoDB for data persistence
  mongodb:
    image: mongo:7.0
    container_name: linkgenai-mongodb-dev
    ports:
      - "27017:27017"
    volumes:
      # Persistent volume for development data
      - mongodb-data:/data/db
    environment:
      - MONGO_INITDB_DATABASE=linkgenai
    healthcheck:
      test: ["CMD", "mongosh", "--eval", "db.adminCommand('ping')"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - linkgenai-network
    restart: unless-stopped

  # NATS for async messaging
  nats:
    image: nats:2.10
    container_name: linkgenai-nats-dev
    ports:
      - "4222:4222"
      - "8222:8222"
    command: ["--js", "--sd", "/data"]
    volumes:
      # Persistent volume for NATS JetStream
      - nats-data:/data
    networks:
      - linkgenai-network
    restart: unless-stopped

networks:
  linkgenai-network:
    driver: bridge

volumes:
  mongodb-data:
    driver: local
  nats-data:
    driver: local
  go-modules:
    driver: local
